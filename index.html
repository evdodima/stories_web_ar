<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Stories Album AR</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Load OpenCV.js asynchronously with more reliable loading -->
    <script src="https://cdn.jsdelivr.net/npm/opencv.js-webassembly@4.2.0/opencv.js" async></script>
    <!-- Load Three.js for WebGL rendering -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <!-- Load JSZip for loading album archives -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="imageTracker.js" defer></script>
</head>
<body>
    <!-- Loading screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="spinner" id="loadingSpinner"></div>
            <div id="loadingErrorIcon" style="display:none; width:48px; height:48px; margin: 0 auto 12px auto;">
                <svg viewBox="0 0 24 24" width="48" height="48" aria-hidden="true">
                    <circle cx="12" cy="12" r="10" fill="#ef4444"></circle>
                    <rect x="11" y="6" width="2" height="8" fill="#ffffff"></rect>
                    <rect x="11" y="16" width="2" height="2" fill="#ffffff"></rect>
                </svg>
            </div>
            <h2>Stories Album AR</h2>
            <div class="loading-progress">
                <div id="loadingProgressBar" class="loading-progress-bar" style="width:0%"></div>
            </div>
            <p id="loadingProgressText">Loading tracking system...</p>
        </div>
    </div>

    <!-- Permission prompt -->
    <div id="permissionPrompt" class="audio-prompt" style="display: none;">
        <div class="audio-prompt-content">
            <h2>ðŸ“· Start AR Experience</h2>
            <p>Allow camera and audio access to begin</p>
            <button id="startARBtn" class="btn btn-primary">Start</button>
        </div>
    </div>

    <div class="app-shell">
        <!-- Fullscreen camera viewport -->
        <main class="viewport viewport-fullscreen">
            <div class="viewport-inner">
                <video id="video" autoplay playsinline></video>
                <canvas id="output"></canvas>
                <canvas id="arCanvas"></canvas>

                <!-- Black overlay for orientation changes -->
                <div id="cameraTransitionOverlay" class="camera-transition-overlay"></div>
            </div>

            <!-- Floating menu button -->
            <button id="menuToggle" class="menu-toggle" aria-label="Toggle menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <!-- Target info overlay -->
            <div id="targetInfo" class="ar-overlay-info"></div>
        </main>

        <!-- Slide-out control panel -->
        <aside class="control-panel" id="controlPanel">
            <header class="panel-header">
                <h1 class="panel-title">Stories Album AR</h1>
                <p class="panel-subtitle">Real-time image tracking</p>
                <button id="closePanel" class="close-panel" aria-label="Close panel">Ã—</button>
            </header>

            <section class="panel-section" data-panel="reference">
                <div class="section-heading">
                    <h2>Target Database</h2>
                    <p>Targets loaded from album archive.</p>
                </div>
                <div class="info-card">
                    <span class="info-label">Album Mode</span>
                    <p class="info-text">Targets are loaded from cloud storage containing images and videos. The vocabulary tree is built dynamically in the browser.</p>
                </div>
            </section>

            <section class="panel-section" data-panel="tracking">
                <div class="section-heading">
                    <h2>Tracking session</h2>
                    <p>Control when detection starts and stops.</p>
                </div>
                <div class="button-row">
                    <button id="startTracking" class="btn btn-primary">Start tracking</button>
                    <button id="stopTracking" class="btn btn-ghost">Stop</button>
                </div>
                <div class="session-badges">
                    <span class="badge-label">Optical flow</span>
                    <span id="opticalFlowBadge" class="badge badge-muted">Armed</span>
                </div>
            </section>

            <section class="panel-section" data-panel="options">
                <div class="section-heading">
                    <h2>Fine tuning</h2>
                    <p>Adjust the tracker to balance performance and stability.</p>
                </div>
                <label class="toggle-row">
                    <input type="checkbox" id="useOpticalFlow" checked>
                    <span class="toggle-label">Use optical flow between detections</span>
                </label>
                <label class="toggle-row">
                    <input type="checkbox" id="visualizeFlowPoints">
                    <span class="toggle-label">Show tracking feature points</span>
                </label>
                <label class="toggle-row">
                    <input type="checkbox" id="showTrackingRects">
                    <span class="toggle-label">Show tracking rectangles</span>
                </label>
                <label class="toggle-row">
                    <input type="checkbox" id="enableVideoOverlay" checked>
                    <span class="toggle-label">Enable video overlay</span>
                </label>
                <label class="toggle-row">
                    <input type="checkbox" id="muteVideos">
                    <span class="toggle-label">Mute videos</span>
                </label>

                <div class="slider-group" data-slider="detection">
                    <div class="slider-header">
                        <span>Detection interval</span>
                        <span id="intervalValue" class="slider-value">15</span>
                    </div>
                    <input type="range" id="detectionInterval" min="1" max="60" value="15">
                    <p class="slider-hint">Lower values refresh more often but use more CPU.</p>
                </div>

                <div class="slider-group" data-slider="features">
                    <div class="slider-header">
                        <span>Max feature points</span>
                        <span id="maxFeaturesValue" class="slider-value">800</span>
                    </div>
                    <input type="range" id="maxFeatures" min="20" max="1000" value="800">
                    <p class="slider-hint">Fewer points improve speed; more points aid stability.</p>
                </div>
            </section>

            <section class="panel-section" data-panel="status">
                <div class="status-card">
                    <span class="status-label">Status</span>
                    <p id="statusMessage" class="status-text">Loading...</p>
                </div>
                <div class="status-card">
                    <span class="status-label">Database</span>
                    <p class="status-text"><span id="databaseInfo">Not loaded</span></p>
                </div>
                <div class="status-card">
                    <span class="status-label">Tracking mode</span>
                    <p class="status-text"><span id="currentMode">Initializing...</span></p>
                </div>
                <div class="status-card">
                    <span class="status-label">Frame rate</span>
                    <p class="status-text"><span id="fpsValue">0 fps</span></p>
                </div>
                <div class="status-card">
                    <span class="status-label">Targets</span>
                    <div id="targetStatusList" class="status-text"></div>
                </div>
            </section>

            <section class="panel-section" data-panel="profiling">
                <div class="section-heading">
                    <h2>Performance profiling</h2>
                    <p>Analyze algorithm bottlenecks.</p>
                </div>
                <div class="button-row">
                    <button id="profileButton" class="btn btn-ghost">Show profile</button>
                    <button id="profileCopyButton" class="btn btn-ghost">Copy stats</button>
                    <button id="profileResetButton" class="btn btn-ghost">Reset</button>
                </div>
                <pre id="profileOutput" style="display: none; font-size: 11px;
                    background: #1a1a1a; padding: 12px; border-radius: 4px;
                    color: #e0e0e0; overflow-x: auto; max-height: 400px;
                    overflow-y: auto; margin-top: 8px;"></pre>
            </section>

            <footer class="panel-footer">
                <p class="footer-note">Feature colors: <span class="dot dot-blue"></span> all keypoints Â· <span class="dot dot-yellow"></span> matches Â· <span class="dot dot-green"></span> inliers</p>
            </footer>
        </aside>
    </div>
</body>
</html>