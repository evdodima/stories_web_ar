# Apache Configuration for OpenCV WebAssembly with Threads Support
#
# These headers enable Cross-Origin Isolation, which is required for
# SharedArrayBuffer (used by the threadsSimd OpenCV build)
#
# Without these headers:
# - threadsSimd build will NOT work
# - App will automatically fall back to simd or wasm build
# - No errors, just slower performance
#
# With these headers:
# - threadsSimd build works (3-4x faster)
# - All external resources must have CORS headers
# - External images/videos need crossorigin="anonymous"

<IfModule mod_headers.c>
    # Enable Cross-Origin Isolation for SharedArrayBuffer support
    Header always set Cross-Origin-Embedder-Policy "require-corp"
    Header always set Cross-Origin-Opener-Policy "same-origin"

    # Allow CORS for OpenCV files
    <FilesMatch "\.(js|wasm)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Cross-Origin-Resource-Policy "cross-origin"
    </FilesMatch>
</IfModule>

# Enable compression for faster loading
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/x-javascript application/wasm
</IfModule>

# Set proper MIME types
<IfModule mod_mime.c>
    AddType application/wasm .wasm
    AddType application/javascript .js
</IfModule>

# Cache OpenCV builds (they're large and don't change often)
<IfModule mod_expires.c>
    ExpiresActive On

    # Cache OpenCV builds for 1 year
    <FilesMatch "opencv\.js$">
        ExpiresDefault "access plus 1 year"
    </FilesMatch>

    # Cache wasm-feature-detect for 1 year
    <FilesMatch "wasm-feature-detect\.js$">
        ExpiresDefault "access plus 1 year"
    </FilesMatch>

    # Cache loader for 1 week (might update more frequently)
    <FilesMatch "loader\.js$">
        ExpiresDefault "access plus 1 week"
    </FilesMatch>
</IfModule>
