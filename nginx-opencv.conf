# Nginx Configuration for OpenCV WebAssembly with Threads Support
#
# USAGE: Include this file in your nginx server block
#
# Example nginx.conf:
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#     root /var/www/webar/current;
#
#     # Include OpenCV-specific configuration
#     include /var/www/webar/current/nginx-opencv.conf;
# }

# Enable Cross-Origin Isolation for SharedArrayBuffer support
# Required for threadsSimd OpenCV build to work
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;

# Allow CORS for OpenCV WebAssembly files
location ~* \.(js|wasm)$ {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
}

# Aggressive caching for OpenCV builds (they're large and don't change often)
location ~* /opencv_builds/.*\.js$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin "*" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
}

# Cache wasm-feature-detect
location ~* /wasm-feature-detect\.js$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin "*" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;
}

# Cache loader.js (might update more frequently)
location ~* /loader\.js$ {
    expires 7d;
    add_header Cache-Control "public";
    add_header Access-Control-Allow-Origin "*" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;
}

# Enable gzip compression for faster loading
gzip on;
gzip_vary on;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/x-javascript application/xml+rss application/json application/wasm;
gzip_min_length 1000;

# Set proper MIME types
types {
    application/wasm wasm;
    application/javascript js;
}
